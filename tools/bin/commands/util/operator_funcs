#!/bin/bash

# Image with which container builds are perfomed
GO_BUILDER_IMAGE="syndesis/godev:1.10"

# Name of the operator image
OPERATOR_IMAGE="syndesis/syndesis-operator"

# globs to test
TEST_TARGETS="./cmd/... ./pkg/..."

# $GOPATH volume to share between docker runs
DOCKER_GOPATH_VOLUME=$(mktemp -d ${TMPDIR:-/tmp}/gopath.XXXXX)

# $XDG_CACHE_HOME ($GOCACHE) volume to share between docker runs
DOCKER_CACHE_VOLUME=$(mktemp -d ${TMPDIR:-/tmp}/gocache.XXXXX)

CLEANUP_DIRS=()

cleanup() {
  rm -rf ${CLEANUP_DIRS[@]}
}

trap cleanup EXIT

dep_ensure() {
    local operator_dir=${1}
    local do_local=${2:-}
    local as_user=${3:-}

    if [ "$do_local" ]; then
        local dir=$(gopath_dir)
        check_error $dir

        pushd $dir >/dev/null
        echo "Running 'dep ensure'"
        dep ensure -vendor-only -v
    else
        echo "Running 'dep ensure' with $GO_BUILDER_IMAGE"
        required_dirs
        local extra_opts=""
        if [ -n "$as_user" ]; then
            extra_opts="$extra_opts -u $as_user"
        fi
        docker run -w /gopath/src/github.com/syndesisio/syndesis/install/operator \
                   -u $(id -u):$(id -g) \
                   $extra_opts \
                   -v "$DOCKER_GOPATH_VOLUME":/gopath:z \
                   -v "$DOCKER_CACHE_VOLUME":/.cache:z \
                   -v $operator_dir/dep-cache:/gopath/pkg/dep:z \
                   -v $operator_dir:/gopath/src/github.com/syndesisio/syndesis/install/operator:z \
                   $GO_BUILDER_IMAGE \
                   dep ensure -vendor-only -v
    fi
}

required_dirs() {
    require_dir "$operator_dir/dep-cache"
    require_dir "$DOCKER_CACHE_VOLUME"
    require_dir "$DOCKER_GOPATH_VOLUME/pkg/dep"
    require_dir "$DOCKER_GOPATH_VOLUME/src/github.com/syndesisio/syndesis/install/operator"

    CLEANUP_DIRS+=($DOCKER_GOPATH_VOLUME)
    CLEANUP_DIRS+=($DOCKER_CACHE_VOLUME)
}

require_dir() {
    local dir=${1}
    [ -d "$dir" ] || mkdir -p $dir
    if [ "$(stat --format '%u:%g' $dir)" != "$(id -u)":"$(id -g)" ]; then
        echo "ERROR: $dir is not owned by the current user"
        exit 1
    fi
}

gopath_dir() {
    set +o nounset
    if [ -z "$GOPATH" ]; then
        if [ ! -d "$HOME/go" ]; then
          echo "ERROR: You have to set your GOPATH environment variable and the $HOME/go directory doesn't exist"
          exit 1
        fi
        GOPATH="$HOME/go"
    fi
    set -o nounset
    local dir=$GOPATH/src/github.com/syndesisio/syndesis/install/operator
    if [ ! -d "$dir" ]; then
        echo "ERROR: No directory $dir"
    fi
    echo $dir
}

build_operator() {
    local operator_dir="${1}"
    local do_local="${2:-}"
    local do_linux="${3:-}"
    local as_user="${4:-}"
    local do_skip_tests="${5:-}"

    if [ ! -d "$operator_dir/vendor" ] || [ $(ls "$operator_dir/vendor" | wc -l) == 0 ]; then
        echo "Running dep ensure implicitely"
        dep_ensure "$operator_dir" "$do_local" "$as_user"
    fi

    if [ "${do_local}" ]; then
        echo "Running local build"
        local dir=$(gopath_dir)
        check_error $dir
        pushd $dir >/dev/null
        if [ ! "$do_skip_tests" ]; then
            echo "Running tests"
            go test $TEST_TARGETS
        fi
        if [ "$do_linux" ] && [ $(isOSX) ]; then
            echo "Cross-compiling syndesis-operator for Linux"
            GOOS="linux" GOARCH="amd64" CGO_ENABLED=0 go build ./cmd/syndesis-operator
        else
            echo "Compiling syndesis-operator with local go"
            go build ./cmd/syndesis-operator
        fi
        popd >/dev/null
    else
        echo "Creating syndesis-operator with $GO_BUILDER_IMAGE"
        local extra_opts=""
        if [ -n "$as_user" ]; then
            extra_opts="$extra_opts -u $as_user -e XDG_CACHE_HOME=.cache"
        fi
        local cmd="(echo Compiling syndesis-operator; go build ./cmd/syndesis-operator)"
        if [ ! "$do_skip_tests" ]; then
            cmd="(echo Running tests; go test $TEST_TARGETS) && $cmd"
        fi
        required_dirs
        docker run -w /gopath/src/github.com/syndesisio/syndesis/install/operator \
                   -u $(id -u):$(id -g) \
                   $extra_opts \
                   -v "$DOCKER_GOPATH_VOLUME":/gopath:z \
                   -v "$DOCKER_CACHE_VOLUME":/.cache:z \
                   -v $operator_dir/dep-cache:/gopath/pkg/dep:z \
                   -v $operator_dir:/gopath/src/github.com/syndesisio/syndesis/install/operator:z \
                   -e CGO_ENABLED=0 \
                   $GO_BUILDER_IMAGE \
                   sh -c "$cmd"
    fi
}

create_multi_stage_operator_image() {
    local operator_dir=${1}
    local tag=${2:-latest}

    local build_dir=$(prepare_multistage_docker_context "$operator_dir")
    pushd $build_dir > /dev/null
    trap "rm -rf $build_dir" EXIT

    echo "Creating multi stage image $OPERATOR_IMAGE:$tag via Docker"
    docker build -t $OPERATOR_IMAGE:${tag} .
    popd
}

create_operator_image() {
    local operator_dir=${1}
    local do_docker=${2:-}
    local tag=${3:-latest}

    local build_dir=$(prepare_docker_context "$operator_dir")
    pushd $build_dir > /dev/null
    trap "rm -rf $build_dir" EXIT

    if [ $do_docker ]; then
        echo "Creating image $OPERATOR_IMAGE:$tag via Docker"
        docker build -t $OPERATOR_IMAGE:${tag} .
        popd
        return
    fi

    setup_oc

    local tmpdir=$(mktemp -d)
    trap "rm -rf $tmpdir" EXIT

    echo "Creating image $OPERATOR_IMAGE:${tag} via S2I and Docker strategy"
    if [ -z "$(oc get bc -o name | grep syndesis-operator)" ]; then
        echo "Creating BuildConfig syndesis-operator"
        oc new-build --strategy=docker --binary=true --name syndesis-operator
    fi

    local arch=$(mktemp -t syndesis-operator-docker-XXXX.tgz)
    tar zcvf $arch Dockerfile syndesis-operator syndesis-template.yml
    trap "rm $arch" EXIT

    oc start-build --from-archive=$arch syndesis-operator

    popd
}

prepare_multistage_docker_context() {
    local operator_dir="${1}"
    local dir=$(mktemp -d)

    cp $operator_dir/Dockerfile-with-build ${dir}/Dockerfile
    cp $operator_dir/Gopkg* ${dir}/
    for i in "cmd" "pkg" "test" "tmp"; do
        rsync -a $operator_dir/${i} ${dir}/ 2>&1 >/dev/null
    done
    cp $operator_dir/../syndesis.yml ${dir}/syndesis-template.yml

    echo $dir
}

prepare_docker_context() {
    local operator_dir="${1}"
    local dir=$(mktemp -d)

    cp $operator_dir/Dockerfile $operator_dir/syndesis-operator ${dir}/
    cp $operator_dir/../syndesis.yml ${dir}/syndesis-template.yml

    echo $dir
}
