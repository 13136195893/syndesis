#!/bin/bash

install::description() {
    echo "Install Syndesis to a connected OpenShift cluster"
}

install::usage() {
    cat <<EOT
-p  --project                 Install into this project. Delete this project
                              if it already exists. By default, install into the current project (without deleting)
    --route                   Route to use (mandatory host name)
    --tag <tag>               Syndesis version/tag to install. If not given, then the latest
                              version from master is installed
    --dev                     Prepare for development of Syndesis so that S2I builds of
                              Syndesis images are picked up properly (implies --watch)
-w  --watch                   Wait until cluster is up
-i  --image-mode <mode>       Which templates to install: "docker" for plain images,
                              "openshift" for image streams (default: "openshift")
    --docker                  Shortcut for "--image-mode docker"
    --local                   install from local Git repo when using. By default the resource descriptor is
                              downloaded from GitHub remotely.
-o  --open                    Open Syndesis in browser when installation is ready (implies --watch)
-y  --yes                     Asume 'yes' automaticlaly when asking for deleting
                              a given project.
EOT
}


install::run() {
    source "$(basedir)/commands/util/openshift_funcs"

    # A route is mandatory
    local route=$(readopt --route)
    if [ -z "$route" ]; then
        echo "No route given. Use --route to set the route."
        exit 1
    fi

    # If a project is given, create it new or recreate it
    local project=$(readopt --project -p)
    if [ -n "${project}" ]; then
        recreate_project $project "$(hasflag --yes -y)"
    fi

    # Setup oc
    setup_oc

    # Required OAuthclient
    create_oauthclient "$(readopt --tag)" "$(hasflag --local)"

    # Apply a template, based on the given arguments
    create_and_apply_template "$route" "$(select_template)" "$(readopt --tag)" "$(hasflag --local)"

    if [ $(hasflag --watch -w) ] || [ $(hasflag --dev) ] || [ $(hasflag --open -o) ]; then
        wait_for_syndesis_to_be_ready
    fi

    if [ $(hasflag --dev) ] && [ $(is_docker_mode) = "false" ]; then
        patch_imagestreams_for_initial_image
    fi

    if [ $(hasflag --open -o) ]; then
        open_url "https://$route"
    fi
}
