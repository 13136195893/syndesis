#!/bin/bash

DEFAULT_OPENSHIFT_VERSION="v3.9.0"
DEFAULT_CPUS="2"
DEFAULT_DISK_SIZE="20GB"
DEFAULT_RAM="4912"

minishift::description() {
    echo "Initialize and manage a Minishift developer environment"
}

minishift::usage() {
    cat <<EOT
    --install                 Install templates to a running Minishift.
-p  --project                 Install into this project. Delete this project if it already exists.
                              By default, install into the current project (without deleting)
-c  --context                 Install into this context. Default is 'minishift'
    --reset                   Reset and initialize the minishift installation by
                              'minishift delete && minishift start'.
    --full-reset              Full reset and initialie by
                              'minishift stop && rm -rf ~/.minishift/* && minishift start'
    --memory <mem>            How much memory to use when doing a reset. Default: $DEFAULT_RAM
    --cpus <nr cpus>          How many CPUs to use when doing a reset. Default: $DEFAULT_CPUS
    --disk-size <size>        How many disk space to use when doing a reset. Default: $DEFAULT_DISK_SIZE
    --vm-driver <driver>      Which virtual machine driver to use (depends on OS)
    --show-logs               Show minishift logs during startup
    --openshift-version <ver> Set OpenShift version to use when reseting (default: $DEFAULT_OPENSHIFT_VERSION)
    --tag <tag>               Syndesis version/tag to install. If not given, then the latest
                              version from master is installed
    --local                   Use the local resource files instead of fetching them from GitHub
-o  --open                    Open Syndesis in the browser
-y  --yes                     Assume 'yes' automatically when asking for deleting
                              a given project.
    --memory-server <mem>     Memory limit to set for syndesis-server. Specify as "800Mi"
    --memory-meta <mem>       Memory limit to set for syndesis-meta. Specify as "512Mi"
    --test-support            Allow test support endpoint for syndesis-server
EOT
}


minishift::run() {
    source "$(basedir)/commands/util/openshift_funcs"

    # Check that mininishift is installed
    which minishift &>/dev/null
    if [ $? -ne 0 ]; then
        echo "ERROR: No 'minishift' found in path."
        echo "Please insall Minishift from https://github.com/MiniShift/minishift"
        exit 1
    fi

    if [ $(hasflag --full-reset) ] || [ $(hasflag --reset) ]; then
        delete_minishift $(hasflag --full-reset)
        start_minishift
    fi

    # Start minishift if necessary
    if [ -z "$(is_minishift_running)" ]; then
        start_minishift
    fi

    # Ensure OC is in the path
    eval $(minishift oc-env)

    if [ $(hasflag --install) ]; then

        local context=$(readopt --context -c)
        if [ -z "${context}" ]; then
            #recreate_context $context
            context="minishift"
        fi

        # Switch to minishift to be safe when deleting projects
        oc config use-context $context

        local project=$(readopt --project -p)
        if [ -n "${project}" ]; then
            recreate_project $project "$(hasflag --yes -y)"
        fi

        # Install the Syndesis custom resource definition, requires admin perms
        local user=$(oc whoami)
        local revert_login=$(login_as_admin)

        local result=$(install_syndesis_crd)
        check_error "$result"

        fixperms "$user"
        $revert_login

        # Deploy operator
        deploy_syndesis_operator
        wait_for_deployments 1 syndesis-operator

        # Create syndesis resource
        create_syndesis

        # Wait and finally patch imagestreams for triggers
        wait_for_deployments 1 syndesis-server syndesis-ui syndesis-meta
        patch_imagestreams_for_initial_image
    fi

    if [ $(hasflag --open -o) ]; then
        open_url "$(minishift openshift service syndesis-oauthproxy --url)"
    fi
}

# Fix up some extra permissions required for a regular minishift user
# Must be run when root
fixperms() {
    local user="$1"
    local extra_role_installed=$(oc get role -o name | grep syndesis-minishift-extra)
    if [ -z "$extra_role_installed" ]; then
        oc create -f - <<EOT
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: syndesis-minishift-extra
  labels:
    app: syndesis
    syndesis.io/app: syndesis
    syndesis.io/type: operator
    syndesis.io/component: syndesis-operator
rules:
- apiGroups:
  - syndesis.io
  resources:
  - syndesises
  - syndesises/finalizers
  verbs: [ get, list, create, update, delete, deletecollection, watch ]
- apiGroups:
  - route.openshift.io
  resources:
  - routes/custom-host
  verbs: [ get, list, create, update, delete, deletecollection, watch ]
---

EOT
    fi

    oc policy add-role-to-user --role-namespace="$(oc project -q)" syndesis-minishift-extra $user
}

login_as_admin() {
    local user=$(oc whoami)
    local token=$(extract_current_token)

    oc login -u system:admin >/dev/null 2>&1

    if [ -n "${token}" ]; then
        echo "oc login -u ${user} -p $token"
    else
        echo "oc login -u ${user}"
    fi
}

extract_current_token() {
    local token=$(oc whoami -t 2>/dev/null)
    if [ $? == 0 ]; then
        echo $token
    fi
}

is_minishift_running() {
    set +e
    minishift status 2>&1 | grep -q "Running"
    local stat=$?
    set -e
    if [ $stat -eq 0 ]; then
      echo "true"
    fi
}

delete_minishift() {
    local remove_all=${1:-}

    if [ $(is_minishift_running) ]; then
      minishift stop
    fi

    minishift delete --clear-cache --force
    if [ $remove_all ] && [ -d ~/.minishift ]; then
        rm -rf ~/.minishift/*
    fi
}

start_minishift() {
    local memory=$(readopt --memory)
    local cpus=$(readopt --cpus)
    local disksize=$(readopt --disk-size)
    local openshift_version=$(readopt --openshift-version)
    local extra_args=""
    if [ $(hasflag --show-logs --show-log) ]; then
        extra_args="--show-libmachine-logs=true "
    fi
    local vmdriver=$(readopt --vm-driver --vmdriver)
    if [ -n "${vmdriver}" ]; then
        extra_args="${extra_args}--vm-driver ${vmdriver} "
    fi

    minishift addons enable admin-user

    echo "Starting minishift ...."
    minishift start ${extra_args:-}--memory ${memory:-$DEFAULT_RAM} --cpus ${cpus:-$DEFAULT_CPUS} --disk-size ${disksize:-$DEFAULT_DISK_SIZE} --openshift-version ${openshift_version:-$DEFAULT_OPENSHIFT_VERSION}
}
