#!/bin/bash

minishift::description() {
    echo "Initialize and manage a Minishift developer environment"
}

minishift::usage() {
    cat <<EOT
    --install                 Install templates to a running Minishift.
-p  --project                 Install into this project. Delete this project if it already exists
-c  --context                 Install into this context. Default is 'minishift'
    --reset                   Reset and initialize the minishift installation by
                              'minishift delete && minishift start'.
    --full-reset              Full reset and initialie by
                              'minishift stop && rm -rf ~/.minishift && minishift start'
    --memory <mem>            How much memory to use when doing a reset. Default: 4GB
    --cpus <nr cpus>          How many CPUs to use when doing a reset. Default: 2
    --disk-size <size>        How many disk space to use when doing a reset. Default: 20GB
    --show-logs               Show minishift logs during startup
    --openshift-version <ver> Set OpenShift version to use when reseting (default: v3.6.0)
                              already existing for --install.
                              Default project: "syndesis"
    --tag <tag>               Syndesis version/tag to install. If not given, then the latest
                              version from master is installed
    --local                   Use the local resource files instead of fetching them from GitHub
-i  --image-mode <mode>       Which templates to install: "docker" for plain images,
                              "openshift" for image streams (default: "openshift")
    --docker                  Shortcut for "--image-mode docker"
-o  --open                    Open Syndesis in the browser
EOT
}


minishift::run() {
    source "$(basedir)/commands/util/openshift_funcs"

    # Check that mininishift is installed
    which minishift &>/dev/null
    if [ $? -ne 0 ]; then
        echo "ERROR: No 'minishift' found in path."
        echo "Please insall Minishift from https://github.com/MiniShift/minishift"
        exit 1
    fi

    if [ $(hasflag --full-reset) ] || [ $(hasflag --reset) ]; then
        delete_minishift $(hasflag --full-reset)
        start_minishift
    fi

    # Start minishift if necessary
    if [ -z "$(is_minishift_running)" ]; then
      start_minishift
    fi

    # Ensure OC is in the path
    eval $(minishift oc-env)

    if [ $(hasflag --install) ]; then

        local context=$(readopt --context -c)
        if [ -z "${context}" ]; then
            #recreate_context $context
            context="minishift"
        fi

        # Switch to minishift to be safe when deleting projects
        oc config use-context $context

        local project=$(readopt --project -p)
        if [ -n "${project}" ]; then
            recreate_project $project "$(hasflag --yes -y)"
        fi

        basedir=$(appdir)
        check_error "$basedir"

        create_oauthclient "$(readopt --tag)" "$(hasflag --local)"
        add_auth_delegator_role

        create_and_apply_template "syndesis.$(minishift ip).nip.io" "$(select_template)" "$(readopt --tag)" "$(hasflag --local)"

        if [ $(is_docker_mode) = "false" ]; then
          wait_for_syndesis_to_be_ready
          patch_imagestreams_for_initial_image
        fi
    fi

    if [ $(hasflag --open -o) ]; then
        open_url "$(minishift openshift service syndesis-oauthproxy --url)"
    fi
}

is_minishift_running() {
    set +e
    minishift status 2>&1 | grep -q "Running"
    local stat=$?
    set -e
    if [ $? -eq 0 ]; then
      echo "true"
    fi
}

delete_minishift() {
    local remove_all=${1:-}

    if [ $(is_minishift_running) ]; then
      minishift stop
    fi

    minishift delete --clear-cache --force
    if [ $remove_all ] && [ -d ~/.minishift ]; then
        rm -rf ~/.minishift
    fi
}

start_minishift() {
    local memory=$(readopt --memory)
    local cpus=$(readopt --cpus)
    local disksize=$(readopt --disk-size)
    local openshift_version=$(readopt --openshift-version)
    local show_logs_arg=""
    if [ $(hasflag --show-logs --show-log) ]; then
        show_logs_args="--show-libmachine-logs=true "
    fi
    echo "Starting minishift ...."
    minishift start ${show_logs_arg:-}--memory ${memory:-4912} --cpus ${cpus:-2} --disk-size ${disksize:-20GB} --openshift-version ${openshift_version:-v3.6.0}
}
